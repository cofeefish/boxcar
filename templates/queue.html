<!DOCTYPE html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <title>Home Page</title>

</head>
<body>
    <header>
        <h1 class="left-padded">Boxcar</h1>
        <nav>
            <menu class="left-padded">
                <a href="/">Home</a>
                <a href="/queue">Upload Queue</a>
                <a href="/settings">Settings</a>
            </menu>
        </nav>  
    </header>
    <main class="left-padded">
        <h2> ongoing uploads</h2>
        {% if ongoing|length == 0 %}
            <div class="left-padded">
                <p>Upload queue is empty.</p>
            </div>
        {% endif %}
        {% for item in ongoing %}
            <div class="queue-item-ongoing">
                <p>{{ item.job_id }}</p>
                <p>{{ item.start_time }}</p>
                <div name="progress-bar" class="top">
                    <div class="progress" style="width: 100%;">
                    </div>
                </div>
                <p>{{ item.size }}</p>
                <p name="size_element" id="{{ item.job_id }}_size">{{ item.current_size }} / {{ item.complete_size }} -- 0%</p>
                <p>Status: {{ item.status }}</p>
                <button title="cancel"></button>

                <hr>
            </div>
        {% endfor %}
        <div>
            <a href="/upload" class="button">Add to Queue</a>
        </div>
        <hr>
        <h2> recent uploads</h2>
        {% if recent_items|length == 0 %}
            <div class="left-padded">
                <p>No recent uploads.</p>
            </div>
        {% endif %}
        {% for item in recent_items %}
            <div id="queueitem_{{ item.job_id }}" class="queue-item left-padded">
            <meta id="jinja_data_{{ item.job_id }}" data-time="{{ item.time }}", data-path="{{ item.path }}", data-source="{{ item.source }}">
                <div class="flex-col">
                    <h3>{{item.source_printable}}</h3>
                    <a name="create_link" href="/create_post/{{ item.job_id }}" data-job_id="{{ item.job_id }}">{{ item.job_id }}</a>
                    <img src="{{ item.thumbnail }}" alt="Thumbnail" width="100"></img>
                </div>
                <div class="flex-col">
                    <span> &nbsp; </span>
                    <span>Status: {{ item.status }}</span>
                    <span>Date Uploaded: {{ item.date }}</span>
                    <span>Size: {{ item.printable_size }}</span>
                </div>
                <div>
                    <a id="delete_{{ item.job_id }}" class="icon-button" href="#" onclick="deleteitem('{{ item.job_id }}')">
                        <i id="delete_icon_{{ item.job_id }}" class="material-icons">delete</i>
                    </a>
                    <a id="add_{{ item.job_id }}" class="icon-button" name="create_link" data-job_id="{{ item.job_id }}" href="/create_post/{{ item.job_id }}">
                        <i id="add_icon_{{ item.job_id }}" class="material-icons">add</i>
                    </a>
                    <a id="retry_{{ item.job_id }}" class="icon-button" href="/retry/{{ item.job_id }}?time={{ item.date }}{{ item.end_time }}&path='{{ item.path }}'&source='{{ item.source }}'">
                        <i id="retry_icon_{{ item.job_id }}" class="material-icons">replay</i>
                    </a>
                </div>
                
            </div>
            <hr>
        {% endfor %}
    </main>
</body>
<script src="/static/paginatior.js"></script>
<script type="text/javascript">
    function deleteitem(job_id) {
        const message = 'delete ' + String(job_id) + ' permenatly?'
        if (confirm(message)) {
            fetch("/delete_queueitem", {
                method: "POST",
                body: JSON.stringify({
                  job_id: job_id
                }),
                headers: {
                  "Content-type": "application/json; charset=UTF-8"
                }
            })
            .then((response) => response.json())
            .then((json) => console.log(json));

            const queueitem = document.getElementById("queueitem_" + String(job_id))
            queueitem.remove()
        }
    }

    const units = ['B', 'KB', 'MB', 'GB']
    function format_size(){
        const size_elements = document.getElementsByName('size_element');
        for (let index = 0; index < size_elements.length; index++) {
            const element = size_elements[index];
            const element_text = element.innerText; 
            var current_size = Number(element_text.split('/')[0]);
            var full_size = Number(element_text.split('/')[1].split(' -- ')[0]);
            var percentage = element_text.split(' -- ')[1];

            var unit = 0;
            while (full_size >= 1000) {
                current_size /= 1000;
                full_size /= 1000;
                unit += 1;
            };
            const unit_str = units[unit];

            percentage = (current_size / full_size)*100;
            current_size = Math.round(current_size*100)/100;
            full_size = Math.round(full_size*100)/100;
            percentage = Math.round(percentage*10)/10;
            const text = current_size.toString()+"/"+full_size.toString()+unit_str+" -- "+percentage.toString()+"%";
            element.innerText=text;
            
        };
    }
    format_size();

    window.onload  = function() {
        const elements = document.getElementsByName("create_link");

        for (let index = 0; index < elements.length; index++) {
            const element = elements[index];
            const job_id = element.dataset["job_id"]
            const data_id = "jinja_data_"+job_id

            const data_element = document.getElementById(data_id)
            const param_keys = ['time','path','source'];
            const param_values = [data_element.dataset["time"], data_element.dataset["path"], data_element.dataset["source"]];
            
            element.href = create_link(element.href, param_keys, param_values);
            
        }
    }
</script>